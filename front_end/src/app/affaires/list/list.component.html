<!-- ================= PAGE HEADER ================= -->
<div class="page-header mb-3">
  <h3 class="page-title">Affaires</h3>
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="#">Affaires</a></li>
      <li class="breadcrumb-item active">Liste des affaires</li>
    </ol>
  </nav>
</div>

<!-- ================= AJOUT AFFAIRE ================= -->
  <button class="btn btn-gradient-success mb-3"
          (click)="goToAddAffaire()">
    ‚ûï Nouvelle affaire
  </button>

<div class="row">

  <!-- ================= TABLEAU ================= -->
  <div class="col-md-7 mb-3">
    <table class="table table-bordered table-hover" *ngIf="affaires.length">
      <thead class="table-light">
        <tr>
          <th>R√©f√©rence</th>
          <th>Titre</th>
          <th>Client</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let a of affaires"
            (click)="selectAffaire(a)"
            style="cursor:pointer"
            [class.table-secondary]="selectedAffaire?.affaireId === a.affaireId">
          <td>{{ a.reference }}</td>
          <td>{{ a.titre }}</td>
          <td>{{ a.nomClient }}</td>
        </tr>
      </tbody>
    </table>

    <div *ngIf="!affaires.length" class="alert alert-secondary">
      Aucune affaire trouv√©e
    </div>
  </div>

  <!-- ================= DETAILS ================= -->
  <div class="col-md-5">

    <div *ngIf="selectedAffaire; else noSelection"
         class="card shadow-sm">

      <!-- ================= HEADER ‚Äì BARRE D‚ÄôACTIONS ================= -->
      <div class="card-header bg-white border-bottom">

        <!-- Ligne titre -->
        <div class="mb-2">
          <h5 class="mb-0">{{ selectedAffaire.titre }}</h5>
          <small class="text-muted">
            Client : {{ selectedAffaire.nomClient }}
          </small>
        </div>

        <!-- Barre actions -->
        <div class="d-flex justify-content-between align-items-center bg-light rounded p-2">

          <button class="btn btn-success btn-sm"
                  (click)="goToAddLinkedAffaire(selectedAffaire)">
            ‚ûï Cr√©er une affaire
          </button>

          <div class="d-flex gap-1">
            <button class="btn btn-outline-primary btn-sm"
                    (click)="goToEditAffaire(selectedAffaire)">
              ‚úè Modifier
            </button>

            <button class="btn btn-outline-danger btn-sm"
                    (click)="deleteAffaire(selectedAffaire.affaireId)">
              üóë Supprimer
            </button>
          </div>

        </div>
      </div>

      <!-- ================= BODY ================= -->
      <div class="card-body">

        <!-- ================= INFOS ================= -->
        <div class="border-bottom pb-3 mb-3">

          <p>
            <strong>Client :</strong>
            <span class="text-info">{{ selectedAffaire.nomClient }}</span>
          </p>

          <div *ngIf="selectedAffaire.referents?.length">
            <span class="badge bg-warning text-dark">R√©f√©rents</span>
            <ul>
              <li *ngFor="let r of selectedAffaire.referents">
                {{ r.prenom }} {{ r.nom }} ‚Äì {{ r.email }}
              </li>
            </ul>
          </div>

          <div *ngIf="selectedAffaire.technicienId">
            <span class="badge bg-success">Technicien</span>
            <p class="mb-1">
              {{ selectedAffaire.technicienPrenom }}
              {{ selectedAffaire.technicienNom }}
            </p>
          </div>

          <div *ngIf="selectedAffaire.equipeId">
            <span class="badge bg-secondary">√âquipe</span>
            <p class="mb-0">{{ selectedAffaire.equipeNom }}</p>
          </div>

          <div *ngIf="selectedAffaire.chefId">
            <span class="badge bg-danger">Chef</span>
            <p class="mb-1">
              {{ selectedAffaire.chefPrenom }}
              {{ selectedAffaire.chefNom }}
            </p>
          </div>

          <p class="mt-2">
            <strong>Dates :</strong>
            {{ selectedAffaire.dateDebut | date:'shortDate' }} ‚Äì
            {{ selectedAffaire.dateFin | date:'shortDate' }}
          </p>

          <p>
            <strong>Dur√©e :</strong>
            {{ selectedAffaire.dureePrevueHeures || 0 }}h
            {{ selectedAffaire.dureePrevueMinutes || 0 }}m
          </p>

          <p class="mb-1"><strong>M√©mo :</strong></p>
          <p class="bg-light p-2 rounded">
            {{ selectedAffaire.memo || '-' }}
          </p>
        </div>

        <!-- ================= FICHIERS ================= -->
        <div>
          <span class="badge bg-info text-dark mb-2">Fichiers</span>

          <div class="border rounded p-2 mb-2 d-flex align-items-center gap-2">
            <button class="btn btn-outline-primary btn-sm"
                    (click)="fileInput.click()">
              üìÇ Choisir
            </button>

            <small class="text-muted flex-grow-1">
              {{ newFiles.length ? newFiles.length + ' fichier(s)' : 'Aucun fichier' }}
            </small>

            <button class="btn btn-success btn-sm"
                    [disabled]="!newFiles.length"
                    (click)="uploadFiles()">
              üì§ Upload
            </button>

            <input type="file"
                   #fileInput
                   class="d-none"
                   multiple
                   (change)="onFileSelected($event)">
          </div>

          <ul *ngIf="newFiles.length" class="list-group mb-2">
            <li *ngFor="let f of newFiles; let i = index"
                class="list-group-item d-flex justify-content-between">
              {{ f.name }}
              <button class="btn btn-sm btn-outline-danger"
                      (click)="removeNewFile(i)">
                Supprimer
              </button>
            </li>
          </ul>

          <ul *ngIf="selectedAffaire.fichiers?.length"
              class="list-group">
            <li *ngFor="let f of selectedAffaire.fichiers"
                class="list-group-item d-flex justify-content-between">
              {{ f.nom }}

              <div class="d-flex gap-1">
                <a class="btn btn-sm btn-outline-primary"
                   [href]="url_upload + '/' + f.chemin"
                   target="_blank">
                  Voir
                </a>

                <button class="btn btn-sm btn-outline-danger"
                        (click)="removeUploadedFile(f.id)">
                  Supprimer
                </button>
              </div>
            </li>
          </ul>

          <p *ngIf="!selectedAffaire.fichiers?.length"
             class="text-muted mt-2">
            Aucun fichier attach√©
          </p>
        </div>

      </div>
    </div>

    <ng-template #noSelection>
      <div class="alert alert-secondary">
        S√©lectionnez une affaire pour voir les d√©tails
      </div>
    </ng-template>

  </div>
</div>