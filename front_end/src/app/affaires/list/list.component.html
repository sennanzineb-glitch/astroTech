<!-- Page Header -->
<div class="page-header">
  <h3 class="page-title">Affaires</h3>
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="#">Affaires</a></li>
      <li class="breadcrumb-item active" aria-current="page">Liste des affaires</li>
    </ol>
  </nav>
</div>

<button class="btn btn-gradient-success btn-fw mb-3" [routerLink]="['/affaires/edit']">
  Nouvelle affaire
</button>

<div class="row">
  <!-- Tableau des affaires -->
  <div class="col-md-7 mb-3">
    <table class="table table-bordered table-hover" *ngIf="affaires?.length > 0; else noAffaires">
      <thead>
        <tr>
          <th>Référence</th>
          <th>Titre</th>
          <th>Client</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let a of affaires" (click)="selectAffaire(a)"
          [ngClass]="{'table-selected': selectedAffaire?.id === a.id}" style="cursor: pointer;">
          <td>{{ a.reference }}</td>
          <td>{{ a.titre }}</td>
          <td>{{ a.nomClient }}</td>
        </tr>
      </tbody>
    </table>

    <ng-template #noAffaires>
      <div class="alert alert-secondary">
        Aucune affaire trouvée.
      </div>
    </ng-template>
  </div>

  <!-- Détails de l'affaire -->
  <div class="col-md-5">
    <ng-container *ngIf="selectedAffaire; else noSelection">
      <div class="card shadow-sm border-primary">
        <div class="card-header d-flex justify-content-between align-items-center bg-primary text-white">
          <h5 class="mb-0">{{ selectedAffaire.titre }}</h5>
          <div class="btns-actions">
            <button class="btn btn-sm btn-warning me-2">
              <i class="fa fa-pencil"></i>
            </button>
            <button class="btn btn-sm btn-danger" (click)="deleteAffaire(selectedAffaire.affaireId)">
              <i class="fa fa-trash-o"></i>
            </button>
          </div>
        </div>

        <div class="card-body">
          <!-- Client -->
          <p><strong>Client: </strong> <span class="text-info">{{ selectedAffaire.nomClient }}</span></p>

          <!-- Référents -->
          <div *ngIf="selectedAffaire.referents?.length" class="mb-2">
            <span class="badge bg-warning text-dark">Référents</span>
            <ul class="mb-0">
              <li *ngFor="let r of selectedAffaire.referents">
                {{ r.prenom }} {{ r.nom }} - {{ r.email }}
              </li>
            </ul>
          </div>

          <!-- Technicien individuel -->
          <div *ngIf="selectedAffaire.technicienId" class="mb-2">
            <span class="badge bg-success">Technicien</span>
            <p class="mb-0">{{ selectedAffaire.technicienPrenom }} {{ selectedAffaire.technicienNom }}</p>
          </div>

          <!-- Équipe -->
          <div *ngIf="selectedAffaire.equipeId" class="mb-2">
            <span class="badge bg-secondary">Équipe</span>
            <p class="mb-0">{{ selectedAffaire.equipeNom }}</p>
            <small>{{ selectedAffaire.equipeDescription }}</small>
          </div>

          <!-- Chef d'équipe -->
          <div *ngIf="selectedAffaire.chefId" class="mb-2">
            <span class="badge bg-danger">Chef</span>
            <p class="mb-0">{{ selectedAffaire.chefPrenom }} {{ selectedAffaire.chefNom }}</p>
          </div>

          <!-- Membres de l'équipe -->
          <div *ngIf="selectedAffaire.membresEquipe?.length" class="mb-2">
            <span class="badge bg-secondary text-white">Membres de l'équipe</span>
            <ul class="mb-0">
              <li *ngFor="let m of selectedAffaire.membresEquipe">
                {{ m.prenom }} {{ m.nom }}
              </li>
            </ul>
          </div>

          <!-- Fichiers -->
          <div *ngIf="selectedAffaire.fichiers?.length" class="mb-2">
            <span class="badge bg-info text-dark">Fichiers</span>
            <ul class="mb-0">
              <li *ngFor="let f of selectedAffaire.fichiers">
                {{ f.nom }} -
                <a [href]="'http://localhost:3002/uploads/' + f.chemin" target="_blank">Voir</a>
              </li>
            </ul>
          </div>

          <!-- Dates et état -->
          <div class="mt-3">
            <p class="mb-1"><strong>Dates:</strong> {{ selectedAffaire.dateDebut | date:'shortDate' }} - {{
              selectedAffaire.dateFin | date:'shortDate' }}</p>
            <p class="mb-1"><strong>État logement:</strong> {{ selectedAffaire.etatLogement || '-' }}</p>
            <p class="mb-0"><strong>Durée prévue:</strong> {{ selectedAffaire.dureePrevueHeures || 0 }}h {{
              selectedAffaire.dureePrevueMinutes || 0 }}m</p>
          </div>

          <!-- Memo -->
          <div class="mt-3">
            <p><strong>Memo:</strong></p>
            <p class="p-2 bg-light border rounded">{{ selectedAffaire.memo || '-' }}</p>
          </div>
        </div>
      </div>
    </ng-container>

    <ng-template #noSelection>
      <div class="alert alert-secondary">
        Sélectionnez une affaire pour voir les détails
      </div>
    </ng-template>
  </div>
</div>