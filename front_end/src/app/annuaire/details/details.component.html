<!-- ================= PAGE HEADER ================= -->
<div class="page-header mb-3">
  <h3 class="page-title mb-1">Clients</h3>
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb mb-0">
      <li class="breadcrumb-item"><a href="#">Clients</a></li>
      <li class="breadcrumb-item"><a href="#">{{ client?.type_client || '' }}</a></li>
      <li class="breadcrumb-item active" aria-current="page">{{ client?.nom_client || '' }}</li>
    </ol>
  </nav>
</div>

<!-- ================= AJOUT AFFAIRE ================= -->
<button type="button" class="btn btn-gradient-success mb-3" (click)="addChilderClient()">
  ‚ûï Ajouter un client
</button>

<div class="row g-4" *ngIf="client; else noClient">

  <!-- ========================= -->
  <!--     COLONNE GAUCHE       -->
  <!-- ========================= -->
  <div class="col-md-4">

    <!-- Notes -->
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-white shadow-sm text-secondary">
        üìù Notes
      </div>
      <div class="card-body">
        <textarea class="form-control mb-3" rows="6" placeholder="√âcrire une note..."
          [(ngModel)]="client.note"></textarea>
        <button class="btn btn-primary w-100" (click)="saveNote()">
          üíæ Sauvegarder
        </button>
      </div>
    </div>

    <!-- Informations -->
    <div class="card shadow-sm">
      <div class="card-header bg-white shadow-sm text-secondary">Informations</div>
      <div class="card-body">

        <!-- Contacts -->
        <div *ngIf="client?.contacts?.length; else noContacts">
          <div *ngFor="let contact of client?.contacts" class="mb-2 p-2 border rounded">
            <h6 class="fw-bold mb-1">{{ contact?.poste || '‚Äî' }}</h6>

            <!-- Emails -->
            <div class="mb-1">
              <strong>Emails:</strong>
              <ng-container *ngIf="contact?.emails?.length; else noEmailsContact">
                <span *ngFor="let e of contact?.emails; let last = last">
                  {{ e?.email || '‚Äî' }} ({{ e?.type || '‚Äî' }})<span *ngIf="!last">, </span>
                </span>
              </ng-container>
              <ng-template #noEmailsContact>
                <span class="text-muted fst-italic">Aucun email</span>
              </ng-template>
            </div>

            <!-- T√©l√©phones -->
            <div>
              <strong>T√©l√©phones:</strong>
              <ng-container *ngIf="contact?.telephones?.length; else noTelsContact">
                <span *ngFor="let t of contact?.telephones; let last = last">
                  {{ t?.tel || '‚Äî' }} ({{ t?.type || '‚Äî' }})<span *ngIf="!last">, </span>
                </span>
              </ng-container>
              <ng-template #noTelsContact>
                <span class="text-muted fst-italic">Aucun t√©l√©phone</span>
              </ng-template>
            </div>
          </div>
        </div>
        <ng-template #noContacts>
          <p class="text-muted fst-italic">Aucun contact disponible</p>
        </ng-template>

        <!-- Adresse -->
        <div class="mt-3">
          <h6 class="fw-bold mb-1"><i class="bi bi-geo-alt-fill me-1"></i> Adresse</h6>
          <ng-container *ngIf="client?.adresse; else noAddress">
            <p class="mb-0">
              <i class="bi bi-building me-1"></i>
              {{ client?.adresse?.adresse || '' }}, {{ client?.adresse?.code_postal || '' }}, {{ client?.adresse?.ville
              || '' }},
              {{ client?.adresse?.province || '' }}, {{ client?.adresse?.pays || '' }}
              <span *ngIf="client?.adresse?.etage"> - √ât. {{ client?.adresse?.etage }}</span>
              <span *ngIf="client?.adresse?.appartement_local">, Appt {{ client?.adresse?.appartement_local }}</span>
              <span *ngIf="client?.adresse?.batiment">, Bat. {{ client?.adresse?.batiment }}</span>
              <span *ngIf="client?.adresse?.interphone_digicode">, Interphone: {{ client?.adresse?.interphone_digicode
                }}</span>
              <span *ngIf="client?.adresse?.porte_entree">, Porte: {{ client?.adresse?.porte_entree }}</span>
            </p>
          </ng-container>
          <ng-template #noAddress>
            <p class="text-muted fst-italic"><i class="bi bi-building me-1"></i> Aucune adresse enregistr√©e</p>
          </ng-template>
        </div>

      </div>
    </div>

  </div>

  <!-- ========================= -->
  <!--     COLONNE DROITE       -->
  <!-- ========================= -->
  <div class="col-md-8">

    <div class="list-clients row g-2 mb-5">
      <div class="col-md-6 col-lg-6" *ngFor="let client of clients">
        <div class="card shadow-sm h-100 border-0">

          <div class="card-header d-flex justify-content-between align-items-center bg-light">
            <div>
              <span class="fw-bold">
                {{ client.nom_client }} -
                {{ (client.type_client === 'secteur' || client.type_client === 'habitation')
                ? client.reference
                : client.numero }}
              </span>
              <br>
              <small class="text-muted fst-italic">
                Type : <span class="badge bg-secondary">{{ client.type_client | titlecase }}</span>
              </small>
            </div>

            <!-- Groupe des boutons -->
            <div class="btn-group">
              <!-- üîµ Bouton d√©tails -->
              <button *ngIf="client.type_client !== 'habitation'" class="btn btn-sm btn-outline-info me-1"
                (click)="viewDetails(client)">
                <i class="fa fa-eye"></i>
              </button>


              <!-- ‚úè Modifier -->
              <button class="btn btn-sm btn-outline-primary me-1" (click)="editClient(client)">
                <i class="fa fa-edit"></i>
              </button>

              <!-- üóë Supprimer -->
              <button class="btn btn-sm btn-outline-danger" (click)="deleteClient(client.id)">
                <i class="fa fa-trash"></i>
              </button>
            </div>
          </div>

          <div class="card-body">
            <h6 class="card-subtitle mb-2 text-muted">Contacts</h6>

            <div *ngIf="client.contacts?.length > 0; else noContacts">
              <ul class="list-unstyled">
                <li *ngFor="let contact of client.contacts" class="mb-2 p-2 border rounded">
                  <strong>{{ contact.nom_complet }}</strong> -
                  <em>{{ contact.poste }}</em>

                  <!-- Emails -->
                  <div class="mt-1">
                    <span *ngFor="let email of contact.listEmails" class="badge bg-info text-dark me-1">
                      <i class="fa fa-envelope"></i> {{ email.email }}
                    </span>
                  </div>

                  <!-- T√©l√©phones -->
                  <div class="mt-1">
                    <span *ngFor="let tel of contact.listTels" class="badge bg-success me-1">
                      <i class="fa fa-phone"></i> {{ tel.tel }}
                    </span>
                  </div>

                </li>
              </ul>
            </div>

            <ng-template #noContacts>
              <span class="text-secondary">Aucun contact</span>
            </ng-template>

          </div>
        </div>
      </div>

      <div *ngIf="clients.length === 0" class="col-12">
        <div class="alert alert-secondary text-center mt-3">
          Aucun client trouv√©.
        </div>
      </div>
    </div>

    <div class="historique">
      <h4 class="fw-bold mb-3 text-secondary">üìú Historique des affaires (Client)</h4>
      <div class="table-responsive shadow-sm rounded">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>R√©f√©rence</th>
              <th>Client</th>
              <th>Titre</th>
              <th>Pi√®ces jointes</th>
              <th>√âch√©ance</th>
              <th>Interventions</th>
              <th>Derni√®re intervention</th>
              <th>Archiv√©e</th>
            </tr>
          </thead>
          <tbody>
            <!-- *** *** *** -->
          </tbody>
        </table>
        <div class="alert alert-secondary text-center mt-3">
          Aucun historique trouv√©.
        </div>
      </div>
    </div>

  </div>
</div>

<ng-template #noClient>
  <p class="text-muted fst-italic">Aucun client s√©lectionn√©</p>
</ng-template>

<!-- *** Modal d'ajout / modification *** -->
<app-modal-save #modalSave (clientAdded)="getAllClients()" (clientUpdated)="getAllClients()">
</app-modal-save>